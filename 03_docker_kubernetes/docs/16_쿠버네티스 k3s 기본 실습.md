# 쿠버네티스 k3s 기본 실습

```
K3s란? 
- k8s 경량화 버전
- etcd 대신 sqlite 활용
- minikube 와 다르게 멀티노드 기능
```

## master node 에 k3s 설치

```bash
# 쿠버네티스 k3s 설치
$ curl -sfL https://get.k3s.io | sh -

# 참고: k3s 삭제
$ sudo sh /usr/local/bin/k3s-uninstall.sh

# 설치된 k3s 확인하기
$ sudo systemctl status k3s

# 노드(서버) 확인하기 (kubectl 명령어 동작을 위해 k3s.yaml 읽기권한 추가 필요)
$ kubectl get node
$ sudo chmod +r /etc/rancher/k3s/k3s.yaml
$ kubectl get node

# 쿠버네티스의 모든 Pod(컨테이너) 확인
$ kubectl get pod -A

```

## worker 노드 추가

```bash
# Master 노드(서버)를 기준으로 토큰 내용 복사하기
$ sudo cat /var/lib/rancher/k3s/server/node-token

# Worker 노드(서버)를 기준으로 k3s 설치스크립트 받기
$ curl -sfL https://get.k3s.io > install_k3s.sh

# (Master 노드에) Worker 노드추가 하기
# Master 노드(서버)의 IP 주소와 토큰을 기준으로 Worker 노드(서버)에서 k3s-agent 설치
$ K3S_URL=https://"마스터 노드 IP 주소":6443 K3S_TOKEN="Master노드토큰" sh install_k3s.sh

# 참고: k3s-agent 삭제
$ sudo sh /usr/local/bin/k3s-agent-uninstall.sh
```

## worker 노드 추가 결과 확인하기

```bash
# Master 노드(서버)에서 노드추가 결과 확인하고
# sub-node 의 ROLE를 worker 로 표시하기
# # kubectl label node <node name> <label key>=<label value>
$ kubectl get node
$ kubectl label node sub-node node-role.kubernetes.io/worker=worker
$ kubectl get node

# 참고: 라벨 삭제 명령어
# kubectl label node <node name> <label key>-
$ kubectl label node sub-node node-role.kubernetes.io/worker-

# 참고: 노드 삭제 명령어
$ kubectl delete node sub-node

```

## 쿠버네티스 기반 웹서버 컨테이너 실행하기

```bash
# hub.docker.com 에 업로드 되어있는
# reallinux/web-server 이미지
# 버전 : 1
# pod (컨테이너) 로 실행하기
$ kubectl run web-server --image reallinux/web-server:1

# 현재 Pod 확인하기
$ kubectl get pods
NAME         READY   STATUS    RESTARTS   AGE
web-server   1/1     Running   0          17s

# 현재 Pod 확인정보 자세히 보기
$ kubectl get pods -o wide
$ kubectl describe pods web-server

# 현재 상태에서는 Pod 의 웹서버(nodejs)에 접속확인
$ curl "Pod IP Address"
Hello World !

# Pod 의 컨테이너 내부로 접속 후 확인하기
$ kubectl exec -it web-server -- bash
$ ps -ef | grep node
root           1       0  0 07:18 ?        00:00:00 /bin/sh -c node app.js
root           7       1  0 07:18 ?        00:00:00 node app.js
$ exit

```

Docker Hub에 Public으로 올라간 이미지면 내 계정이 아니어도 Kubernetes가 자동으로 pull해서 Pod로 실행한다.

## Pod를 yaml 파일을 통해서 실행하기

```bash
# 현재 실행중인 Pod 삭제하기
$ kubectl delete pods web-server

# yaml 파일 생성하기
$ vim web-server-pod.yaml
$ cat web-server-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-server
  labels:
    app: web
spec:
  containers:
    - name: web-server
      image: reallinux/web-server:1
      ports:
        - containerPort: 80
          protocol: TCP
          
# yaml 파일을 통해서 Pod 실행하기
$ kubectl apply -f web-server-pod.yaml
# 참고 : yaml 파일을 통해서 Pod 삭제
$ kubectl delete -f web-server-pod.yaml

# Pod 확인
$ kubectl get pods

```